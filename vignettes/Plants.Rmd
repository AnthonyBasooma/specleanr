---
title: "Detecting environmental outliers in species distribution models for plants."
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Detecting environmental outliers in species distribution models for plants.}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, message=FALSE}

library(specleanr)

```

***Detect environmental outliers for species occurrences in *Fagus sylvatica*, and *Populus nigra* records based on bioclimatic data**.


To test the workflow on two plant species, namely the black poplar (*Populus nigra*) , which is a pioneer wind-pollinated deciduous tree from the Salicaceae family (de Rigo et al., 2016). The tree is distributed across Europe, Asia, and northern Africa (de Rigo et al., 2016; Harvey-Brown et al., 2017) and predominantly in flood plains in mixed forests (Harvey-Brown et al., 2017). The mature tree lives up to 300 to 400 years (de Rigo et al., 2016), and it has been assessed as data deficient according to IUCN RedList (Harvey-Brown et al., 2017). Secondly, we considered the European beech or common beech (*Fagus sylvatica*), which is also a deciduous hardy tree species that can tolerate various soil habitats but is not tolerant of waterlogged areas (Barstow et al., 2018). Although mature individuals have declined, the tree species IUCN RedList threat status is assessed as Least Concern (Barstow et al., 2018).

1. **Data acquisition: a) species records**

Data was retrieved from the iNaturalist (https://www.inaturalist.org/) and Global Biodiversity Information Facility-GBIF (https://www.gbif.org/). We use the **`getdata()`** function, built around rvertnet, rgbif, and rinat packages. We limited the occurrence records from GBIF to 700 and Inaturalist to 100. To extract data from the dataonline class returned by **`getdata()`**, we used the **`extract_online()`** function.
**Note**: If the user has locally saved data, then after extracting the online data, the **`match_datasets()`** function can be used to merge all the data sets. 

```{r get species occurences}
plantdf <- getdata(data = c( "Populus nigra", "Fagus sylvatica"), 
                    gbiflim = 700, inatlim = 100, isFish = FALSE,
                     hasCoordinate = TRUE, 
                   bbox = c(xmin = 8.15250, ymin = 42.08333, xmax=29.73583, ymax = 50.24500),
                   verbose = FALSE, warn = FALSE)


extrdata <- extract_online(plantdf)

```
1. **Data acquisition: b) Environmental data**

We used WORLDCLIM data archived in the package to enable users to test the package functions seamlessly. For direct interaction with the WORDCLIM data, please visit (https://www.worldclim.org/) and the **`geodata`** package for download in user-customized workflows.

```{r environmental parameters from WORLDCLIM}

#Get climatic variables from the package folder

worldclim <- system.file('extdata/worldclim.tiff', package = 'specleanr')

worldclim <- terra::rast(worldclim)

```

2. **Preliminary analysis**

The step involves removing missing coordinate values, setting the geographical range for the data collated in **1.a**, if the user did not set the bounding box during data download. After that, the environmental data predictors are extracted. The user can set either parameter **list = TRUE** to return a list of datasets for each species, if multiple species are considered, or **list = FALSE** to return a combined dataframe.

```{r extract data and prelimianry analysis}

danube <- system.file('extdata/danube/basinfinal.shp', package = 'specleanr')

danube_basin  <-     sf::st_read(danube, quiet=TRUE)


plantcleaned <-  pred_extract(data= extrdata, 
                             raster= worldclim, 
                             lat = 'decimalLatitude',
                             lon = 'decimalLongitude',
                             colsp = 'species',  
                             multiple = TRUE, 
                             bbox = danube_basin,
                             list= TRUE, 
                             minpts = 10, merge = FALSE, verbose = FALSE, warn = FALSE)

sp1df <- subset(extrdata, species=="Populus nigra")

p1cleaned <-  pred_extract(data= sp1df, 
                             raster= worldclim, 
                             lat = 'decimalLatitude',
                             lon = 'decimalLongitude',
                             colsp = 'species',  
                             multiple = FALSE, 
                             bbox = danube_basin,
                             list= TRUE, 
                             minpts = 10, merge = FALSE, verbose = FALSE, warn = FALSE)

```

3. **Detecting outliers using multiple outlier detection methods**

```{r oultlier detection , fig.width = 6, fig.height= 5, fig.align='center'}

outliersdata <- multidetect(data = plantcleaned,
                       multiple = TRUE,
                       var = 'bio1',
                       output = 'outlier',
                       exclude = c('x','y'), 
                       methods = c('adjbox', "hampel", 'zscore', 'lof', 'jknife'),
                       showErrors  = TRUE, warn = F, verbose = F)

out1df <- multidetect(data = p1cleaned,
                       multiple = FALSE,
                       var = 'bio1',
                       output = 'outlier',
                       exclude = c('x','y'), 
                       methods = c('adjbox', "hampel", 'zscore', 'lof', 'jknife'),
                       showErrors  = TRUE, warn = F, verbose = F)

ggoutliers(outliersdata, 1, raw=FALSE)

#for one species
ggoutliers(out1df)

```

```{r best methods}

mbest <- multibestmethod(x = outliersdata, autothreshold = TRUE)

```



4. **Extracting clean data set after outlier detection**

The mode can be set to **mode = abs** to discard only absolute outliers or **mode = best** to use the best method.

```{r extract outliers from clean dataset}

cleandf <- clean_data_extract(refdata = plantcleaned, outliers = outliersdata, 
                         mode = "best", threshold = 0.4, warn = FALSE, verbose = TRUE, pabs = 0.1)


cleandf1 <- clean_data_extract(refdata = p1cleaned, outliers = out1df, 
                         mode = "best", threshold = 0.4, warn = FALSE, verbose = TRUE, pabs = 0.1)


```

5. **Model comparison**

```{r data cleaning scenarios}

multsppmodel <- modelcomparison(refdata = plantcleaned, outliers = outliersdata, raster = worldclim,
                           lat = 'y', lon = 'x', models = c("GLM"), mode = 'abs',
                           thresholds = seq(0.2, 0.7, 0.1), full = FALSE)



onesppmodel <- modelcomparison(refdata = p1cleaned, outliers = out1df, raster = worldclim,
                           lat = 'y', lon = 'x', models = c("GLM"), mode = 'abs',  
                           thresholds = seq(0.2, 0.7, 0.1), full = TRUE)

```

**Extract model performance**

```{r extract performanc}

onespp <- get_performance(modeloutput = onesppmodel)

multspp <- get_performance(modeloutput = multsppmodel)


```

**Plotting to visualize comparisons**

```{r visualisation, fig.width = 6, fig.height= 5, fig.align='center'}
#one species 
ggperform(modelout = onesppmodel, cutoff = 0.5)+
  theme_bw()

ggperform(modelout = multsppmodel, cutoff = 0.5)+
  theme_bw()


```


### References 

1. Harvey-Brown, Y., Barstow, M., Mark, J. & Rivers, M.C. 2017. Populus nigra. The IUCN Red List of Threatened Species 2017: e.T63530A68106816. https://dx.doi.org/10.2305/IUCN.UK.2017-3.RLTS.T63530A68106816.en. Accessed on 24 June 2024.

2. de Rigo, D., Enescu, C.M., Houston Durrant, T. and Caudullo, G. 2016. Populus nigra in Europe: distribution, habitat, usage and threats. European Atlas of Forest Tree Species, Publications Office of the European Union, Luxembourg.

3. Barstow, M. & Beech, E. 2018. Fagus sylvatica. The IUCN Red List of Threatened Species 2018: e.T62004722A62004725. https://dx.doi.org/10.2305/IUCN.UK.2018-1.RLTS.T62004722A62004725.en. Accessed on 24 June 2024.





